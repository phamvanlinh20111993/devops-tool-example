
---

# https://microk8s.io/docs/getting-started
- name: Install microk8s
  ansible.builtin.snap:
    name: microk8s
    state: present
    channel: 1.31
    classic: yes
 
- name: Join the groups
  ansible.builtin.shell: |
    sudo usermod -a -G microk8s $USER
    mkdir -p ~/.kube
    chmod 0700 ~/.kube
    su - $USER
    microk8s status --wait-ready
  
- name: Enable add-ons
  ansible.builtin.shell: |
    microk8s enable dns
    microk8s enable hostpath-storage
    microk8s enable dashboard registry storage ingress
    
- name: Setup 
  ansible.builtin.shell: |
    sudo ufw allow in on cni0 && sudo ufw allow out on cni0
    sudo ufw default allow routed
    
    ipRange="10.1.1.9-10.250.250.250"
    echo "$ipRange" | sudo microk8s enable metallb
    unset ipRange;
    
    if [ -f ~/.bash_aliases ] && ! sudo grep -q "microk8s kubectl" ~/.bash_aliases; then 
        echo "alias kubectl='microk8s kubectl'" | sudo tee -a ~/.bash_aliases
    fi
    sleep 10
    
    sudo microk8s kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v1.0.2/cert-manager.yaml
    
    token=$(sudo microk8s kubectl -n kube-system get secret | grep default-token | cut -d " " -f1)
    sudo microk8s kubectl -n kube-system describe secret $token
    sleep 30
    
- name: Enable the Microk8s service
  ansible.builtin.systemd:
    name: microk8s
    enabled: yes

- name: Start the Microk8s service
  ansible.builtin.systemd:
    name: microk8s
    state: started